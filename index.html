<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cocina Mexicana & Chefcito</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* ================= APPLE SYSTEM EST√âTICA ================= */
        :root {
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-surface: rgba(255, 255, 255, 0.85); 
            --glass-highlight: rgba(255, 255, 255, 0.9);
            --app-bg: #F2F2F7;
            --active-blue: #007AFF;
            --spoil-good: #34C759;
            --spoil-warn: #FF9500;
            --spoil-bad: #FF3B30;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--app-bg);
            color: #1C1C1E;
            padding-bottom: 120px;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        /* Ambient Light */
        .ambient-light {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: #F2F2F7;
            overflow: hidden;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: floatOrb 15s infinite ease-in-out alternate;
        }
        .orb-1 { top: -10%; left: -10%; width: 60vw; height: 60vw; background: #FFD60A; }
        .orb-2 { bottom: 0%; right: -20%; width: 70vw; height: 70vw; background: #FF9F0A; animation-delay: -5s; }

        @keyframes floatOrb {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        /* Glass Panels */
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .inventory-card {
            transition: all 0.2s ease;
        }
        .inventory-card.active {
            background: #FFFFFF;
            border-color: var(--active-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }

        /* QR Scanner */
        #settings-modal { transition: opacity 0.3s ease; }
        #qr-reader video { object-fit: cover; border-radius: 12px; }

        /* Navigation */
        .nav-glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(50px);
            border-top: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.05);
        }
        .bottom-nav-item.active { color: var(--active-blue); }

        /* Utility */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-magic {
            background: linear-gradient(135deg, #4285F4, #9B72CB, #D96570);
            background-size: 200% 200%;
            animation: gradientMove 3s ease infinite;
            color: white;
        }
        @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    </style>
</head>
<body>

    <div class="ambient-light">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <!-- HEADER -->
    <header class="sticky top-0 z-50 px-5 py-3 pointer-events-none">
        <div class="glass-panel rounded-2xl px-5 py-4 flex flex-col gap-3 pointer-events-auto">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-[11px] uppercase tracking-widest text-gray-500 font-bold">Bienvenido</p>
                    <h1 class="text-2xl font-bold text-gray-900">Mi Cocina</h1>
                </div>
                <div class="flex gap-2">
                    <button onclick="openSettings()" class="w-10 h-10 rounded-full bg-white border flex items-center justify-center shadow-sm text-gray-600 active:scale-90 transition">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button onclick="installAppInstructions()" class="w-10 h-10 rounded-full bg-white border flex items-center justify-center shadow-sm text-blue-500 active:scale-90 transition">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            
            <div class="relative">
                <input type="text" id="global-search" placeholder="Buscar recetas..." 
                       class="w-full bg-gray-100/50 rounded-xl py-3 pl-10 pr-4 text-sm focus:outline-none focus:bg-white border border-transparent focus:border-blue-500 transition-all">
                <i class="fas fa-search absolute left-3.5 top-3.5 text-gray-400"></i>
            </div>
        </div>
    </header>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Configuraci√≥n</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-black"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-2xl border text-center">
                    <div id="qr-reader" class="hidden rounded-xl overflow-hidden mb-4 border-2 border-blue-500 h-64 w-full"></div>
                    <button id="btn-start-scan" onclick="startScanner()" class="w-full bg-black text-white py-3 rounded-xl font-bold text-sm shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-qrcode"></i> Escanear API Key
                    </button>
                    <button id="btn-stop-scan" onclick="stopScanner()" class="hidden w-full bg-red-100 text-red-600 py-3 rounded-xl font-bold text-sm">Detener C√°mara</button>
                </div>

                <div class="relative">
                    <input type="password" id="api-key-input" placeholder="O pega tu API Key aqu√≠..." class="w-full bg-gray-100 rounded-xl py-3 pl-4 pr-10 text-sm">
                    <button onclick="toggleKeyVisibility()" class="absolute right-3 top-3 text-gray-400"><i class="far fa-eye" id="eye-icon"></i></button>
                </div>

                <button onclick="saveSettings()" class="w-full bg-green-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-green-500/30">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main id="app-content" class="p-5 max-w-2xl mx-auto fade-in min-h-screen pb-32"></main>

    <!-- NAVIGATION -->
    <nav class="fixed bottom-6 left-4 right-4 nav-glass rounded-[30px] px-4 py-3 flex justify-between items-center z-50 md:w-full md:max-w-md md:mx-auto border border-white/50 shadow-2xl">
        <button onclick="router('home')" id="nav-home" class="bottom-nav-item active flex flex-col items-center text-gray-400 w-12 transition-colors">
            <i class="fas fa-home text-xl mb-1"></i><span class="text-[9px] font-bold">Inicio</span>
        </button>
        <button onclick="router('inventory')" id="nav-inventory" class="bottom-nav-item flex flex-col items-center text-gray-400 w-12 transition-colors">
            <i class="fas fa-carrot text-xl mb-1"></i><span class="text-[9px] font-bold">Despensa</span>
        </button>
        <button onclick="router('ai-chef')" class="relative -top-8">
            <div class="w-14 h-14 rounded-full btn-magic flex items-center justify-center shadow-lg shadow-purple-500/30 border-4 border-[#F2F2F7]">
                <i class="fas fa-wand-magic-sparkles text-lg"></i>
            </div>
        </button>
        <button onclick="router('recipes')" id="nav-recipes" class="bottom-nav-item flex flex-col items-center text-gray-400 w-12 transition-colors">
            <i class="fas fa-book-open text-xl mb-1"></i><span class="text-[9px] font-bold">Recetas</span>
        </button>
        <button onclick="router('favorites')" id="nav-favorites" class="bottom-nav-item flex flex-col items-center text-gray-400 w-12 transition-colors">
            <i class="fas fa-heart text-xl mb-1"></i><span class="text-[9px] font-bold">Favs</span>
        </button>
    </nav>

    <!-- APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Global State
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.inventoryMap = new Map();
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cocina-mexicana-app';
        
        // Extended shelf life data for new items
        const shelfLifeDB = {
            'pollo': 3, 'res': 4, 'cerdo': 4, 'camaron': 2, 'huevo': 21, 
            'jamon': 7, 'salchicha': 10, 'crema': 10, 'leche': 7, 'queso': 14,
            'tomate': 7, 'tomate_verde': 7, 'lechuga': 5, 'cilantro': 5, 'aguacate': 4, 'limon': 20,
            'pi√±a': 5, 'granada': 10, 'cebolla': 14, 'ajo': 30, 'chile': 14, 'chile_poblano': 10,
            'elote': 5, 'rabano': 10, 'arroz': 365, 'frijoles': 365, 'pasta': 365, 'tortillas': 6, 'pan': 3,
            'maiz_pozolero': 365, 'tostadas': 90, 'fideos': 365, 'masa': 3, 'aceite': 365, 'achiote': 365
        };

        // --- FIREBASE SETUP ---
        async function initApp() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        setupInventoryListener();
                    } else {
                        signInAnonymously(window.auth).catch(console.error);
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                Swal.fire("Error", "No se pudo conectar a la base de datos.", "error");
            }
        }

        function setupInventoryListener() {
            if (!window.userId) return;
            const q = collection(window.db, 'artifacts', appId, 'users', window.userId, 'inventory');
            
            onSnapshot(q, (snapshot) => {
                window.inventoryMap.clear();
                snapshot.forEach((doc) => {
                    window.inventoryMap.set(doc.id, doc.data());
                });
                // Refresh inventory UI if active
                if (document.getElementById('inventory-grid')) {
                    renderInventoryUI();
                }
                updateCounters();
            }, (error) => console.error("Snapshot error:", error));
        }

        // --- GLOBAL EXPORTS FOR HTML ACCESS ---
        window.updateInventoryItem = async (ingId, change) => {
            if (!window.userId) return;
            const itemRef = doc(window.db, 'artifacts', appId, 'users', window.userId, 'inventory', ingId);
            const current = window.inventoryMap.get(ingId);

            if (!current && change > 0) {
                // ADD NEW
                await setDoc(itemRef, {
                    id: ingId,
                    amount: 1,
                    addedAt: Date.now(),
                    shelfLifeDays: shelfLifeDB[ingId] || 7
                });
            } else if (current) {
                const newAmount = current.amount + change;
                if (newAmount <= 0) {
                    await deleteDoc(itemRef);
                } else {
                    // Update amount only, keep date
                    await setDoc(itemRef, { amount: newAmount }, { merge: true });
                }
            }
        };

        // Start App
        initApp();
    </script>

    <!-- UI SCRIPTS -->
    <script>
        // --- DATA ---
        const categoriasInventario = [
            { id: 'frutas', nombre: 'Frutas', icon: 'fa-apple-alt', gradient: 'grad-red' },
            { id: 'verduras', nombre: 'Verduras', icon: 'fa-carrot', gradient: 'grad-green' },
            { id: 'proteinas', nombre: 'Prote√≠na', icon: 'fa-drumstick-bite', gradient: 'grad-orange' },
            { id: 'lacteos', nombre: 'L√°cteos', icon: 'fa-cheese', gradient: 'grad-blue' },
            { id: 'despensa', nombre: 'Despensa', icon: 'fa-bread-slice', gradient: 'grad-purple' },
            { id: 'otros', nombre: 'Otros', icon: 'fa-utensils', gradient: 'grad-gray' }
        ];

        const ingredientesComunesDB = [
            { id: 'pollo', nombre: 'Pollo', cat: 'proteinas' },
            { id: 'res', nombre: 'Carne de Res', cat: 'proteinas' },
            { id: 'cerdo', nombre: 'Carne de Cerdo', cat: 'proteinas' },
            { id: 'huevo', nombre: 'Huevo', cat: 'proteinas' },
            { id: 'jamon', nombre: 'Jam√≥n', cat: 'proteinas' },
            { id: 'salchicha', nombre: 'Salchicha', cat: 'proteinas' },
            { id: 'camaron', nombre: 'Camar√≥n', cat: 'proteinas' },
            { id: 'tomate', nombre: 'Tomate', cat: 'verduras' },
            { id: 'tomate_verde', nombre: 'Tomate Verde', cat: 'verduras' },
            { id: 'cebolla', nombre: 'Cebolla', cat: 'verduras' },
            { id: 'ajo', nombre: 'Ajo', cat: 'verduras' },
            { id: 'chile', nombre: 'Chiles', cat: 'verduras' },
            { id: 'chile_poblano', nombre: 'Chile Poblano', cat: 'verduras' },
            { id: 'elote', nombre: 'Elote (Ma√≠z)', cat: 'verduras' },
            { id: 'cilantro', nombre: 'Cilantro', cat: 'verduras' },
            { id: 'lechuga', nombre: 'Lechuga', cat: 'verduras' },
            { id: 'rabano', nombre: 'R√°bano', cat: 'verduras' },
            { id: 'aguacate', nombre: 'Aguacate', cat: 'frutas' },
            { id: 'limon', nombre: 'Lim√≥n', cat: 'frutas' },
            { id: 'pi√±a', nombre: 'Pi√±a', cat: 'frutas' },
            { id: 'granada', nombre: 'Granada', cat: 'frutas' },
            { id: 'tortillas', nombre: 'Tortillas', cat: 'despensa' },
            { id: 'maiz_pozolero', nombre: 'Ma√≠z Pozolero', cat: 'despensa' },
            { id: 'frijoles', nombre: 'Frijoles', cat: 'despensa' },
            { id: 'arroz', nombre: 'Arroz', cat: 'despensa' },
            { id: 'pan', nombre: 'Pan (Bolillo)', cat: 'despensa' },
            { id: 'tostadas', nombre: 'Tostadas', cat: 'despensa' },
            { id: 'fideos', nombre: 'Fideos', cat: 'despensa' },
            { id: 'masa', nombre: 'Masa de Ma√≠z', cat: 'despensa' },
            { id: 'aceite', nombre: 'Aceite', cat: 'despensa' },
            { id: 'pasta', nombre: 'Pasta', cat: 'despensa' },
            { id: 'achiote', nombre: 'Achiote', cat: 'despensa' },
            { id: 'queso', nombre: 'Queso', cat: 'lacteos' },
            { id: 'crema', nombre: 'Crema', cat: 'lacteos' },
            { id: 'leche', nombre: 'Leche', cat: 'lacteos' }
        ];

        const recetasMexicanas = [
            {
                id: 1,
                nombre: "Huevos Rancheros",
                descripcion: "Huevos fritos sobre tortilla ba√±ados en salsa roja.",
                imagen: "https://upload.wikimedia.org/wikipedia/commons/2/28/Huevos_rancheros_832957.jpg",
                tiempo: 15,
                dificultad: "F√°cil",
                categoria: "Desayuno",
                ingredientesBase: ["huevo", "tortillas", "tomate", "cebolla", "chile", "aceite"],
                instrucciones: ["Prepara una salsa roja b√°sica.", "Pasa tortillas por aceite.", "Fr√≠e huevos estrellados.", "Monta: Tortilla, huevo, salsa."],
                tips: ["El epazote en la salsa le da un toque aut√©ntico."]
            },
            {
                id: 2,
                nombre: "Molletes",
                descripcion: "Bolillo tostado con frijoles y queso gratinado.",
                imagen: "https://media.istockphoto.com/id/1144221195/photo/mexican-molletes-recipe-with-fresh-sauce.jpg?s=612x612&w=0&k=20&c=02nsvDwOWSQ6A6SHD670iZWmr0qCtsbv_WdQW375Z6Y=", 
                tiempo: 15,
                dificultad: "Muy F√°cil",
                categoria: "Desayuno",
                ingredientesBase: ["pan", "frijoles", "queso"],
                instrucciones: ["Corta el bolillo.", "Unta frijoles.", "Cubre con queso y gratina.", "Sirve con Pico de Gallo."],
                tips: ["Agrega chorizo o jam√≥n debajo del queso."]
            },
            {
                id: 3,
                nombre: "Enfrijoladas",
                descripcion: "Tortillas sumergidas en salsa cremosa de frijol.",
                imagen: "https://www.paulinacocina.net/wp-content/uploads/2023/10/receta-de-enfrijoladas-paulina-cocina-recetas-800x450.jpg",
                tiempo: 20,
                dificultad: "F√°cil",
                categoria: "Comida",
                ingredientesBase: ["tortillas", "frijoles", "queso", "crema", "cebolla"],
                instrucciones: ["Lic√∫a frijoles con caldo.", "Hierve la salsa.", "Suaviza tortillas en aceite.", "Pasa por salsa, dobla y sirve."],
                tips: ["A√±ade chipotle a la salsa."]
            },
            {
                id: 4,
                nombre: "Guacamole",
                descripcion: "El cl√°sico dip de aguacate mexicano.",
                imagen: "https://www.vegrecipesofindia.com/wp-content/uploads/2012/01/guacamole11.jpg",
                tiempo: 10,
                dificultad: "Muy F√°cil",
                categoria: "Botana",
                ingredientesBase: ["aguacate", "tomate", "cebolla", "cilantro", "limon", "chile"],
                instrucciones: ["Pica verdura fina.", "Machaca aguacate.", "Mezcla con lim√≥n y sal."],
                tips: ["Deja el hueso para evitar oxidaci√≥n."]
            },
            {
                id: 5,
                nombre: "Sincronizadas",
                descripcion: "Tortilla rellena de jam√≥n y queso fundido.",
                imagen: "https://img.freepik.com/fotos-premium/quesadillas-mexicanas-tradicionales-jamon-rebanadas-tambien-llamadas-sincronizadas_338367-3575.jpg?semt=ais_hybrid&w=740",
                tiempo: 10,
                dificultad: "Muy F√°cil",
                categoria: "Cena",
                ingredientesBase: ["tortillas", "jamon", "queso"],
                instrucciones: ["Tortilla + Jam√≥n + Queso + Tortilla.", "Calienta hasta derretir.", "Corta en 4."],
                tips: ["Acompa√±a con guacamole."]
            },
            {
                id: 6,
                nombre: "Tostadas de Pollo",
                descripcion: "Tostada crujiente con frijoles, pollo y crema.",
                imagen: "https://t4.ftcdn.net/jpg/02/09/75/55/360_F_209755553_pnSYocVsAumSaWW9MFhw4TMjexTvkcjP.jpg",
                tiempo: 25,
                dificultad: "F√°cil",
                categoria: "Comida",
                ingredientesBase: ["tortillas", "pollo", "frijoles", "lechuga", "crema", "queso"],
                instrucciones: ["Tostada frita.", "Unta frijoles.", "Pon pollo, lechuga, crema y queso."],
                tips: ["Escurre bien la lechuga."]
            },
            {
                id: 7,
                nombre: "Sopa de Tortilla",
                descripcion: "Caldo de tomate con tiras fritas de tortilla.",
                imagen: "https://media.istockphoto.com/id/1288015660/es/foto/taz%C3%B3n-de-sopa-de-tortilla-de-pollo.jpg?s=612x612&w=0&k=20&c=uBRa6N1CbE4JI6tfUU-fhkPwGmbnfWrdKPpovfj6n00=",
                tiempo: 35,
                dificultad: "Media",
                categoria: "Sopa",
                ingredientesBase: ["tortillas", "tomate", "cebolla", "ajo", "aguacate", "queso", "crema", "aceite"],
                instrucciones: ["Fr√≠e tiras de tortilla.", "Haz caldillo de tomate.", "Sirve caldo sobre tiras."],
                tips: ["Sirve las tiras aparte."]
            },
            {
                id: 8,
                nombre: "Chilaquiles Verdes",
                descripcion: "Totopos ba√±ados en salsa verde picante.",
                imagen: "https://www.pequerecetas.com/wp-content/uploads/2024/01/como-tomar-chilaquiles-verdes-con-huevo-frito-y-pollo.jpg",
                tiempo: 30,
                dificultad: "Media",
                categoria: "Desayuno",
                ingredientesBase: ["tortillas", "tomate_verde", "cebolla", "chile", "cilantro", "pollo", "crema", "queso"],
                instrucciones: ["Totopos fritos + Salsa verde hirviendo.", "Sirve con crema, queso y cebolla."],
                tips: ["Ba√±a al momento para crujientes."]
            },
            {
                id: 9,
                nombre: "Pico de Gallo",
                descripcion: "Salsa bandera fresca.",
                imagen: "https://images.immediate.co.uk/production/volatile/sites/30/2011/06/pico-c513c13.jpg?quality=90&resize=606,550",
                tiempo: 10,
                dificultad: "Muy F√°cil",
                categoria: "Salsa",
                ingredientesBase: ["tomate", "cebolla", "cilantro", "chile", "limon"],
                instrucciones: ["Pica todo en cubos.", "Mezcla con lim√≥n y sal."],
                tips: ["Quita semillas del tomate."]
            },
            {
                id: 10,
                nombre: "Flautas de Pollo",
                descripcion: "Tacos dorados enrollados.",
                imagen: "https://us.123rf.com/450wm/marcoscastillo/marcoscastillo2005/marcoscastillo200500449/147047569-tacos-dorados-flautas-de-pollo-tacos-de-pollo-y-salsa-picante-comida-casera-mexicana-en-mexico.jpg?ver=6",
                tiempo: 40,
                dificultad: "Media",
                categoria: "Comida",
                ingredientesBase: ["tortillas", "pollo", "aceite", "lechuga", "crema", "queso"],
                instrucciones: ["Tortilla caliente + Pollo.", "Enrolla y fr√≠e en aceite abundante.", "Sirve con crema y queso."],
                tips: ["Aceite muy caliente."]
            },
            {
                id: 11,
                nombre: "Pozole Rojo",
                descripcion: "Caldo tradicional con carne de cerdo y ma√≠z.",
                imagen: "https://www.casademexico.es/wp-content/uploads/2022/08/pozole-rojo-pagina.jpg",
                tiempo: 120,
                dificultad: "Dif√≠cil",
                categoria: "Comida",
                ingredientesBase: ["maiz_pozolero", "cerdo", "chile", "lechuga", "rabano", "limon", "cebolla"],
                instrucciones: ["Cuece el ma√≠z hasta que reviente.", "Cuece la carne.", "Lic√∫a chiles secos y agr√©galos al caldo.", "Hierve todo junto.", "Sirve con lechuga, r√°bano y or√©gano."],
                tips: ["Usa cabeza de lomo para m√°s sabor."]
            },
            {
                id: 12,
                nombre: "Cochinita Pibil",
                descripcion: "Cerdo marinado en achiote estilo Yucat√°n.",
                imagen: "https://media.istockphoto.com/id/1217896108/es/foto/cochinita-pibil-servida-con-salsa-habanero-yucatcea-y-cebolla-enesada.jpg?s=612x612&w=0&k=20&c=GsOG1kZ54_1l0oioHR66plVvjqiaVFBmOT1xFW6frCo=",
                tiempo: 180,
                dificultad: "Dif√≠cil",
                categoria: "Comida",
                ingredientesBase: ["cerdo", "achiote", "limon", "cebolla", "tortillas"],
                instrucciones: ["Marina el cerdo en achiote y jugo c√≠trico.", "Cocina a fuego muy lento (horno u olla) hasta deshacerse.", "Sirve en tacos con cebolla morada encurtida."],
                tips: ["Mejor si marinas toda la noche."]
            },
            {
                id: 13,
                nombre: "Esquites",
                descripcion: "Granos de elote cocidos con epazote.",
                imagen: "https://img.freepik.com/free-photo/tasty-esquites-with-spices-high-angle_23-2149891122.jpg?semt=ais_hybrid&w=740",
                tiempo: 45,
                dificultad: "F√°cil",
                categoria: "Botana",
                ingredientesBase: ["elote", "cebolla", "chile", "limon", "mayonesa", "queso"],
                instrucciones: ["Sofr√≠e cebolla y chile.", "Agrega granos de elote y agua/caldo.", "Hierve con epazote hasta suavizar.", "Sirve en vaso con mayonesa, queso y chile."],
                tips: ["Usa elote fresco, no de lata."]
            },
            {
                id: 14,
                nombre: "Sopa de Fideo",
                descripcion: "La sopa casera por excelencia.",
                imagen: "https://static.bainet.es/clip/db7005f7-70ca-4e02-b56a-75acab162680_source-aspect-ratio_1600w_0.jpg",
                tiempo: 25,
                dificultad: "Muy F√°cil",
                categoria: "Sopa",
                ingredientesBase: ["fideos", "tomate", "cebolla", "ajo", "aceite"],
                instrucciones: ["Fr√≠e el fideo hasta dorar.", "Lic√∫a tomate, cebolla y ajo.", "Vierte la salsa sobre el fideo.", "Agrega agua y cocina hasta suavizar."],
                tips: ["No dejes quemar el fideo, solo dorado."]
            },
            {
                id: 15,
                nombre: "Tacos Dorados de Papa",
                descripcion: "Tacos crujientes rellenos de pur√© de papa.",
                imagen: "https://img-global.cpcdn.com/recipes/2efef73729eb89bb/300x426cq80/tacos-dorados-de-carne-deshebrada-con-papa-foto-principal.jpg",
                tiempo: 40,
                dificultad: "Media",
                categoria: "Comida",
                ingredientesBase: ["tortillas", "papa", "aceite", "lechuga", "queso", "crema"],
                instrucciones: ["Haz un pur√© de papa sazonado.", "Rellena tortillas y cierra.", "Fr√≠e en aceite hasta dorar.", "Sirve con repollo/lechuga y salsa."],
                tips: ["El pur√© debe estar fr√≠o para que no salte el aceite."]
            },
            {
                id: 16,
                nombre: "Agua de Horchata",
                descripcion: "Bebida refrescante de arroz y canela.",
                imagen: "https://www.gastrolabweb.com/u/fotografias/m/2022/3/25/f848x477-27501_85304_6363.jpg",
                tiempo: 60,
                dificultad: "F√°cil",
                categoria: "Bebida",
                ingredientesBase: ["arroz", "leche", "azucar", "canela"],
                instrucciones: ["Remoja arroz y canela.", "Lic√∫a todo muy bien.", "Cuela y mezcla con leche y az√∫car.", "Sirve con mucho hielo."],
                tips: ["Agrega leche condensada para m√°s cremosidad."]
            },
            {
                id: 17,
                nombre: "Chiles en Nogada",
                descripcion: "Platillo barroco de temporada.",
                imagen: "https://media.istockphoto.com/id/1168255647/es/foto/chiles-en-nogada-mexican-food.jpg?s=612x612&w=0&k=20&c=QWyY97p-akwzuxQoa3XEMkV-f5KKrW4R61-JDz1jrxY=",
                tiempo: 150,
                dificultad: "Experto",
                categoria: "Comida",
                ingredientesBase: ["chile_poblano", "cerdo", "res", "frutas", "crema", "nuez", "granada"],
                instrucciones: ["Asa y pela los chiles.", "Prepara picadillo con carne y frutas.", "Rellena chiles.", "Ba√±a con salsa de nogada (nuez y crema).", "Decora con granada."],
                tips: ["La nuez de castilla es esencial."]
            },
            {
                id: 18,
                nombre: "Tamales Verdes",
                descripcion: "Masa de ma√≠z rellena de pollo en salsa verde.",
                imagen: "https://dorastable.com/wp-content/uploads/2023/12/tamales-verdes-3.jpg",
                tiempo: 120,
                dificultad: "Dif√≠cil",
                categoria: "Desayuno",
                ingredientesBase: ["masa", "pollo", "tomate_verde", "chile", "aceite"],
                instrucciones: ["Bate la masa con manteca/aceite.", "Prepara salsa verde con pollo.", "Arma tamales en hojas de ma√≠z.", "Cuece al vapor 1 hora."],
                tips: ["La masa flota en agua cuando est√° lista para usar."]
            },
            {
                id: 19,
                nombre: "Arroz con Leche",
                descripcion: "Postre cremoso tradicional.",
                imagen: "https://static.vecteezy.com/system/resources/thumbnails/004/480/540/small/close-up-rice-pudding-with-cinnamon-in-glass-container-wooden-spoon-with-raw-rice-free-photo.jpg",
                tiempo: 40,
                dificultad: "F√°cil",
                categoria: "Postre",
                ingredientesBase: ["arroz", "leche", "azucar", "canela"],
                instrucciones: ["Cuece arroz con agua y canela.", "Agrega leches y cocina a fuego lento.", "Mueve constante para espesar."],
                tips: ["Usa leche evaporada."]
            },
            {
                id: 20,
                nombre: "Tacos al Pastor Caseros",
                descripcion: "Cerdo marinado con pi√±a.",
                imagen: "https://tastesbetterfromscratch.com/wp-content/uploads/2023/04/Tacos-Al-Pastor-7.jpg",
                tiempo: 60,
                dificultad: "Media",
                categoria: "Cena",
                ingredientesBase: ["cerdo", "pi√±a", "cebolla", "cilantro", "chile", "tortillas"],
                instrucciones: ["Marina carne con chiles y achiote.", "Fr√≠e en sart√©n bien caliente.", "Sirve con pi√±a, cilantro y cebolla."],
                tips: ["Corta la carne muy delgada."]
            }
        ];

        // --- RENDER FUNCTIONS ---
        function router(view) {
            const container = document.getElementById('app-content');
            container.innerHTML = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            document.querySelectorAll('.bottom-nav-item').forEach(el => el.classList.remove('active'));
            const btn = document.getElementById(`nav-${view}`);
            if(btn) btn.classList.add('active');

            if(view === 'home') renderHome(container);
            if(view === 'inventory') renderInventoryUI(container);
            if(view === 'recipes') renderRecipes(container);
            if(view === 'ai-chef') renderAI(container);
            if(view === 'favorites') renderFavorites(container);
        }

        // 1. HOME
        function renderHome(container) {
            container.innerHTML = `
                <div class="glass-panel rounded-2xl p-6 mb-6 text-center cursor-pointer active:scale-95 transition" onclick="router('inventory')">
                    <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-500 text-2xl shadow-inner">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Gestionar Inventario</h2>
                    <p class="text-gray-500 text-sm mt-1">Lleva el control de caducidad y compras</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    ${categoriasInventario.map(cat => `
                        <div class="glass-panel p-4 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-white/50" onclick="router('inventory')">
                            <div class="w-10 h-10 rounded-lg ${cat.gradient} text-white flex items-center justify-center"><i class="fas ${cat.icon}"></i></div>
                            <span class="font-bold text-sm text-gray-700">${cat.nombre}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 2. INVENTORY UI (FIXED & UPGRADED)
        function renderInventoryUI(targetContainer) {
            // If called from router, use passed container. If refresh, get by ID.
            const container = targetContainer || document.getElementById('app-content');
            if(!container) return;

            const total = window.inventoryMap ? window.inventoryMap.size : 0;

            let html = `
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Mi Despensa</h2>
                        <p class="text-sm text-gray-500">${total} productos guardados</p>
                    </div>
                    <button onclick="abrirChefTable()" class="btn-magic px-4 py-2 rounded-full text-xs font-bold shadow-lg flex items-center gap-2 active:scale-95 transition">
                        <i class="fas fa-wand-magic-sparkles"></i> Cocinar
                    </button>
                </div>
                
                <div id="inventory-grid" class="space-y-8 pb-20">
            `;

            categoriasInventario.forEach(cat => {
                const items = ingredientesComunesDB.filter(i => i.cat === cat.id);
                if(items.length === 0) return;

                html += `
                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-6 h-6 rounded-md flex items-center justify-center text-xs text-white ${cat.gradient}"><i class="fas ${cat.icon}"></i></div>
                            <h3 class="font-bold text-gray-800 text-sm uppercase tracking-wide">${cat.nombre}</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                `;

                items.forEach(ing => {
                    const data = window.inventoryMap.get(ing.id);
                    const hasItem = !!data;
                    const amount = data ? data.amount : 0;
                    
                    // Date & Expiration Logic
                    let detailsHTML = '';
                    let statusColor = '';
                    let borderClass = 'border-transparent';

                    if (hasItem) {
                        const addedDate = new Date(data.addedAt);
                        const dateStr = addedDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                        
                        const now = Date.now();
                        const daysPassed = (now - data.addedAt) / (1000 * 60 * 60 * 24);
                        const shelfLife = data.shelfLifeDays || 7;
                        const daysLeft = Math.ceil(shelfLife - daysPassed);
                        
                        let expText = `${daysLeft} d√≠as`;
                        let expColor = 'text-green-600';
                        statusColor = 'border-l-4 border-green-500';

                        if(daysLeft <= 3) { expColor = 'text-orange-500'; statusColor = 'border-l-4 border-orange-500'; }
                        if(daysLeft <= 0) { expText = 'Vencido'; expColor = 'text-red-600'; statusColor = 'border-l-4 border-red-500'; }

                        detailsHTML = `
                            <div class="mt-3 pt-2 border-t border-gray-100 w-full space-y-1">
                                <div class="flex justify-between text-[10px] text-gray-500">
                                    <span>üìÖ Agregado:</span>
                                    <span class="font-medium">${dateStr}</span>
                                </div>
                                <div class="flex justify-between text-[10px] ${expColor}">
                                    <span>‚è∞ Expira:</span>
                                    <span class="font-bold">${expText}</span>
                                </div>
                            </div>
                        `;
                        borderClass = statusColor;
                    }

                    html += `
                        <div class="glass-panel p-3 rounded-xl flex flex-col items-center text-center inventory-card relative overflow-hidden ${hasItem ? 'active bg-white' : 'bg-white/40'} ${borderClass}">
                            
                            <div class="text-2xl mb-1">${getIcon(ing.id)}</div>
                            <span class="text-xs font-bold text-gray-800 leading-tight">${ing.nombre}</span>
                            
                            <!-- Controls -->
                            <div class="flex items-center gap-3 mt-2 bg-gray-100 rounded-lg p-1">
                                <button onclick="window.updateInventoryItem('${ing.id}', -1)" class="w-6 h-6 bg-white rounded shadow-sm text-gray-600 hover:text-red-500 font-bold">-</button>
                                <span class="text-xs font-bold w-4">${amount}</span>
                                <button onclick="window.updateInventoryItem('${ing.id}', 1)" class="w-6 h-6 bg-white rounded shadow-sm text-gray-600 hover:text-green-500 font-bold">+</button>
                            </div>

                            ${detailsHTML}
                        </div>
                    `;
                });

                html += `</div></div>`;
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        // 3. AI CHEF & SELECTION
        function abrirChefTable() {
            const available = [];
            window.inventoryMap.forEach((val, key) => {
                const meta = ingredientesComunesDB.find(i => i.id === key);
                if(meta) available.push({ ...val, name: meta.nombre, id: key });
            });

            if(available.length === 0) {
                Swal.fire({ icon: 'warning', title: 'Despensa Vac√≠a', text: 'Agrega ingredientes primero.'});
                return;
            }

            const listHtml = available.map(item => `
                <label class="flex items-center justify-between p-3 border rounded-xl cursor-pointer hover:bg-gray-50">
                    <span class="flex items-center gap-2 text-sm font-medium">
                        <input type="checkbox" value="${item.name}" checked class="accent-blue-500 item-checkbox">
                        ${item.name} (${item.amount})
                    </span>
                    <span>${getIcon(item.id)}</span>
                </label>
            `).join('');

            Swal.fire({
                title: 'üë®‚Äçüç≥ Mesa del Chef',
                html: `
                    <div class="text-left">
                        <p class="text-xs text-gray-500 mb-3">Elige tus ingredientes:</p>
                        <div class="max-h-48 overflow-y-auto space-y-2 mb-4">${listHtml}</div>
                        <input id="chef-notes" class="w-full bg-gray-100 p-3 rounded-xl text-sm" placeholder="Escribe instrucciones extra (ej: picante)...">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Crear Receta',
                confirmButtonColor: '#007AFF',
                preConfirm: () => {
                    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
                    const selected = Array.from(checkboxes).map(cb => cb.value);
                    const notes = document.getElementById('chef-notes').value;
                    return { selected, notes };
                }
            }).then((res) => {
                if(res.isConfirmed) generateRecipe(res.value);
            });
        }

        async function generateRecipe({ selected, notes }) {
            if(selected.length === 0) return Swal.fire('Ups', 'Selecciona algo', 'error');
            
            Swal.fire({ title: 'Cocinando...', didOpen: () => Swal.showLoading() });
            
            const prompt = `Crea una receta detallada usando: ${selected.join(', ')}. Notas: ${notes}. Usa Markdown.`;
            const response = await callGemini(prompt);
            
            Swal.close();
            Swal.fire({
                title: '‚ú® Receta Sugerida',
                html: `<div class="text-left text-sm max-h-[60vh] overflow-y-auto prose prose-sm">${marked.parse(response)}</div>`,
                width: '600px'
            });
        }

        // --- GEMINI API ---
        async function callGemini(prompt) {
            const key = localStorage.getItem('gemini_api_key');
            if(!key) { openSettings(); return "Configura tu API Key primero."; }

            // URL for Gemini 2.0 Flash-Lite
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite-preview-02-05:generateContent?key=${key}`;
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error en la IA";
            } catch(e) {
                return "Error de conexi√≥n";
            }
        }

        // --- SETTINGS / QR ---
        let html5QrCode;
        window.openSettings = () => {
            document.getElementById('api-key-input').value = localStorage.getItem('gemini_api_key') || '';
            document.getElementById('settings-modal').classList.remove('hidden');
        };
        window.closeSettings = () => {
            window.stopScanner();
            document.getElementById('settings-modal').classList.add('hidden');
        };
        window.saveSettings = () => {
            const key = document.getElementById('api-key-input').value.trim();
            if(key) {
                localStorage.setItem('gemini_api_key', key);
                closeSettings();
                Swal.fire('Guardado', 'Llave actualizada', 'success');
            }
        };
        window.toggleKeyVisibility = () => {
            const inp = document.getElementById('api-key-input');
            inp.type = inp.type === 'password' ? 'text' : 'password';
        };
        window.startScanner = () => {
            document.getElementById('qr-reader').classList.remove('hidden');
            document.getElementById('btn-start-scan').classList.add('hidden');
            document.getElementById('btn-stop-scan').classList.remove('hidden');
            
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (txt) => {
                    document.getElementById('api-key-input').value = txt;
                    window.stopScanner();
                    Swal.fire('Escaneado', 'C√≥digo detectado', 'success');
                }
            );
        };
        window.stopScanner = () => {
            if(html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => html5QrCode.clear());
            }
            document.getElementById('qr-reader').classList.add('hidden');
            document.getElementById('btn-start-scan').classList.remove('hidden');
            document.getElementById('btn-stop-scan').classList.add('hidden');
        };
        window.installAppInstructions = () => {
            Swal.fire({
                title: 'Instalar App',
                html: '<div class="text-left text-sm"><p class="mb-2"><strong>iOS (Safari):</strong> Toca "Compartir" <i class="fas fa-share-square"></i> y luego "Agregar a Inicio" <i class="far fa-plus-square"></i>.</p><p><strong>Android (Chrome):</strong> Toca Men√∫ <i class="fas fa-ellipsis-v"></i> y "Instalar aplicaci√≥n".</p></div>'
            });
        };

        // --- HELPERS ---
        function getIcon(id) {
            const map = {
                'pollo': 'üçó', 'res': 'ü•©', 'cerdo': 'üçñ', 'huevo': 'ü•ö', 'jamon': 'ü•ì', 'salchicha': 'üå≠', 'camaron': 'ü¶ê',
                'tomate': 'üçÖ', 'tomate_verde': 'üü¢', 'cebolla': 'üßÖ', 'ajo': 'üßÑ', 'chile': 'üå∂Ô∏è', 'chile_poblano': 'üå∂Ô∏è',
                'elote': 'üåΩ', 'cilantro': 'üåø', 'lechuga': 'ü•¨', 'rabano': 'üî¥', 'aguacate': 'ü•ë', 'limon': 'üçã', 'pi√±a': 'üçç', 'granada': 'üî¥',
                'tortillas': 'ü´ì', 'maiz_pozolero': 'üåΩ', 'frijoles': 'ü´ò', 'arroz': 'üçö', 'pan': 'ü•ñ', 'tostadas': 'üçò', 'fideos': 'üçú',
                'masa': 'ü•ü', 'aceite': 'üåª', 'pasta': 'üçù', 'achiote': 'üî¥',
                'queso': 'üßÄ', 'crema': 'ü•õ', 'leche': 'ü•õ'
            };
            return map[id] || 'ü•ò';
        }
        function updateCounters() { /* Optional visual counter logic */ }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => router('home'));

    </script>
</body>
</html>
